# 리팩터링 원칙

- 리팩터링 : 소프트웨어의 겉보기 동작은 그대로 유지한 채, 여러가지 리팩터링 기법을 적용해서 소프트웨어를 재구성하다.
- 기능 추가, 리팩터링 두 개의 모자를 구분해서 바꿔써야한다.

=> 회사에서 유지보수를 할때 코드가 지저분하다면 먼저 리팩토링을 한 후에 커밋을 하고 유지보수를 했었다.(엠티뷰 텍스트)

`누군가 "리팩터링하다가 코드가 깨져서 며칠이나 고생했다"라고 한다면, 십중팔구 리팩터링한 것이 아니다.`

## 리팩터링하는 이유

- 리팩터링하면 소프트웨어 설계가 좋아진다.
- 리팩터링하면 소프트웨어를 이해하기 쉬워진다.
  - 기억에 의존하지말고 코드에 의존해라
- 리팩터링하면 버그를 쉽게 찾을 수 있다.
  - 코드를 이해하기 쉬워지면 버그를 지나치려야 지나칠 수 없을 정도로 명확해진다.
- 리팩터링하면 프로그래밍 속도를 높일 수 있다.
  - 리팩터링하는데 속도가 빨라진다고? 잘못적은게 아니다. 프로그램을 개발하다보면 점점 스파게티 코드가 되고 간단한 기능추가를 하는데도 기존 코드를 이해하기 어려워 시간이 필요이상으로 오래걸리고 사이드이펙트가 발생하는지 여부도 쉽게 알 수 없다. 그리고 이럴때 차라리 처음부터 개발하는게 빠르겠다는 생각이 들기도 한다.
  - 그런데 설계가 잘 된 소프트웨어는 기능을 쉽게 추가할 수 있고 버그가 생길 가능성도 적다.
  - 과거에는 처음부터 완벽히 설계를 마쳐야 한다고 생각했지만 리팩터링을 통해서 언제든지 개선할 수 있다.

## 언제 리팩터링해야할까?

```
3의 법칙
1. 처음에는 그냥 한다.
2. 비슷한 일을 두 번째로 하게 되면(중복이 생겼다는 사실에 당황스럽겠지만), 일단 계속 진행한다.
3. 비슷한 일을 세 번째 하게 되면 리팩터링한다.
```

- 준비를 위한 리팩터링: 기능을 쉽게 추가하게 만들기
  - 오류가 여러군데 퍼져있다면 일단 한 곳으로 모으자
- 이해를 위한 래퍽터링: 코드를 이해하기 쉽게 만들기
  - 내가 이해한것을 코드에 반영해두면 더 오래 보존할 수 있을 뿐만 아니라 동료들도 알 수 있다.
  - 초기 단계의 리팩터링은 밖을 잘 내다보기 위한 창문 닦기와 같다.
  - 이해를 위한 리팩터링을 의미 없이 코드를 만지작거리는 것이라고 무시하는 이들은 복잡한 코드 아래 숨어 잇는 다양한 기회를 결코 발견할 수 없다.
- 쓰레기 줍기 리팩터링
  - 비효율적인 코드를 발견할 때가 있다. 그런데 리팩터링하는데 작업 범위가 너무 큰 경우 바로 리팩터링 할 수는 없다. 그렇다고 쓰레기가 나뒹굴게 방치해서 나중에 일을 방해하도록 내버려두는 것도 좋지 않다. 이럴때는 조금이나마 개선해두자. 그리고 시간이 걸리는 일은 짧은 메모를 남기고 하던 일을 끝내고 나서 처리하자.
  - 리팩터링의 멋진 점은 각각의 작은 단계가 코드를 깨뜨리지 않는다는 사실이다. 그래서 작업을 잘게 나누면 몇 달에 걸쳐 진행하더라도 그 사이 한 순간도 코드가 깨지지 않기도 한다.
  - 이게 가능한 경우도 있지만 실무를 겪어보니 불가능한 경우가 더 많다고 생각한다. 다만 인지는 하고 있어야겠다.
- 계획된 리팩터링과 수시로 하는 리팩터링
  - 항상 수시로 리팩터링해야만 한다. if문을 작성한다고 따로 시간을 내지 않는것처럼 말이다.
  - 보기 싫은 코드를 발견하면 리팩터링하자. 그런데 잘 작성된 코드 역시 수많은 리팩터링을 거쳐야한다.
  - 무언가 수정하려 할 때는 먼저 수정하기 수비게 정돈하고(단, 만만치 않은 수 있다) 그런 다음 쉽게 수정하자.
  - 뛰어난 개발자는 새 기능을 추가하기 쉽도록 코드를 수정하는 것이 그 기능을 가장 빠르게 추가하는 길일 수 있음을 안다.
  - 그렇다고 계획된 리팩터링이 무조건 나쁜건아니다. 그동안 소홀했다면 개선할 필요가 있다.
- 오래 걸리는 리팩터링
  - 리팩터링은 대부분 금방 끝난다. 하지만 대규모 리팩터링도 있다. 저자는 팀 전체가 리팩터링에 매달리는 데는 회의적이다. 누구든지 관련된 작업을 할 때 조금씩 개선하는 것이 좋다. 이게 가능한건 리팩터링이 코드를 깨트리지 않기 때문이다.
- 코드리뷰에 리팩터링 활용하기
  - 코드리뷰를 하면 다른 사람의 아이디어를 얻을 수 있다. 또한 리팩터링은 다른 이의 코드를 리뷰하는 데도 도움이 된다. 리팩터링을 활용하기 전에는 그럭저럭 이해한 뒤, 몇 가지 개선사항들을 제시했다. 지금은 실제로 리팩터링 해보고 적용할 수도 있다. 이 방법은 pr, mr같은 방식보다는 페어 프로그래밍에서 효과적이다.
- 관리자에게는 뭐라고 말해야 할까?
  - 관리자가 기술에 정통하다면 쉽게 설득할 수 있다. 하지만 기술을 모르는 상당수의 관리자와 고객은 코드베이스의 건강상태가 생산성에 미치는 영향을 모른다. 이런 상황에서는 리팩터링한다고 말하지 말아라.
  - 하극상이 아니다. 우리는 프로 개발자다. 구체적인 방뻐은 개발자가 판단해야한다.
- 리팩터링하지 말아야 할 때
  - 굳이 수정할 필요가 없다면 리팩터링하지 않는다. 또는 외부 api 다루듯 호출해서 쓰기만 한다면 그냥 내버려둔다. 처음부터 새로 작성하는게 쉬울 때도 리팩터링하지 않는다. 사실 리팩터링하는것과 새로 작성하는 것 중 어느것이 빠를지는 쉽게 판단할 수 없다. 알아서 잘 판단해라. 파이팅!!

## 리팩터링 시 고려할 문제

- 새 기능 개발 속도 저하
  - 리팩터링의 궁극적인 목적은 개발 속도를 높여서, 더 적은 노력으로 더 많은 가치를 창출하는 것이다. 경제적인 측면에서 하는 것이다. 다른 이유가 아니다.
- 코드 소유권
  - 코드 소유권이 한 사람에게만 위임되어 있으면 리팩터링이 어려워진다. 특별한 경우가 아니라면 소유권을 모두에게 주자.
- 브랜치
  - 팀원마다 코드베이스의 브랜치를 하나씩 맡아서 결과물이 쌓이면 마스터 브랜치에 통합하는 방법이다. 이 방법의 단점은 독립적인 브랜치로 작성하는 기간이 길어질수록 통일하기 어렵다는 것이다. 이때문에 되도록 빨리 합치는 것이 좋다.
  - 지속적 통합 Continuous Integration(CI), 또는 트렁크 기반 개발 Trunk-Based development(TBD)라고 한다. CI에 따르면 모든 팀원이 하루에 최소 한 번은 마스터와 통합해야한다.
  - 머지 복잡도를 줄이는 데도 도움이 되지만 리팩터링과 궁합이 좋다. 켄트 백은 CI와 리팩터링을 합쳐서 익스트림 프로그래밍 eXtream Programing(XP)이라고 부른다.
- 테스팅
  - 테스트코드가 작성되어 있으면 리팩터링의 불안감을 줄일 수 있다. 그리고 자동 리팩터링 기능을 사용한다면 테스트 코드가 없어도 제한적이지만 안전하게 리팩터링할 수 있다.
  - 자연스럽게 지속적 배포 Continuous Develop(CD)와도 연관이 된다.
- 레거시 코드

  - 레거시 시스템을 파악할 때 리펙터링이 굉장히 도움된다. 그런데 테스트가 하나도 없다면 어떨까?? 테스트코드없이 대규모 시스템을 리팩터링하기엔 너무나도 위험하다. 이 문제의 정답은 테스트 보강이다.
  - 쉽게 해결할 수는 없다. 테스트코드가 고려되지 않은 코드는 쉽게 테스트할 수 없다. 그래서 비집고 들어가서 테스트를 추가하고 테스트를 추가할 수 없다면 어쩔수없지만 그냥 리팩터링해야한다.
  - 서로 관련된 부분끼리 나눠서 하나씩 조금씩 리팩터링하자. 모든 코드를 한번에 바꾸는 것을 저자는 추천하지 않는다. 캠핑규칙에 따라 처음보다 정돈된 상태를 만들면 된다.

## 리팩터링, 아키텍쳐, 애그니(YAGNI)

- 리팩터링을 통해서 얼마든지 설계를 바꿀 수 있다. 일단 만들고 요구사항을 완전히 이해하기 되었을 때 아키텍쳐를 리팩터링하자. 이런식으로 설계하는 방식은 간단한 설계, 점진적 설계, YAGNI(you aren't going to need it 필요없을거다)

## 리팩터링과 소프트웨어 개발 프로세스

리팩터링의 첫번째 토대는 자가 테스트 코드다.

## 리팩터링과 성능

대부분 프로그래밍은 전체 코드 중 극히 일부에서 대부분의 시간을 소비한다. 그래서 전체 코드를 고르게 최적화한다면 그중 90%는 거의 효과가 없기 때문에 시간낭비이다. 즉 의도적으로 성능 최적화에 돌입하기 전까지는 성능에 신경 쓰지 않고 코드를 다루기 쉽게 만드는데 집중한다. 그러다 성능 최적화 단계가 되면 다음의 구체적인 절차를 다라 프로그램을 튜닝한다.
